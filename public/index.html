<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI名片王 Pro - 智能分片管理</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; padding: 30px; text-align: center; border-radius: 15px; margin-bottom: 30px; }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .card h2 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .btn-danger { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .success { color: #27ae60; font-weight: 600; }
        .error { color: #e74c3c; font-weight: 600; }
        .info { color: #3498db; font-weight: 600; }
        .shard-info { background: linear-gradient(45deg, #f8f9fa, #e9ecef); padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #667eea; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; }
        .search-results { margin-top: 25px; max-height: 500px; overflow-y: auto; }
        .result-item { background: linear-gradient(45deg, #f8f9fa, #ffffff); padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 4px solid #667eea; transition: transform 0.2s; }
        .result-item:hover { transform: translateX(5px); }
        .loading { text-align: center; padding: 20px; color: #666; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .search-mode { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-mode button { padding: 8px 16px; font-size: 12px; }
        .search-mode button.active { background: #667eea; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s; }
        .auto-setup-panel { background: linear-gradient(45deg, #11998e, #38ef7d); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 AI名片王 Pro</h1>
            <p>智能分片管理系統 - 支援100萬用戶 | 毫秒級搜尋 | 自動化管理</p>
        </div>

        <!-- 自動設定面板 -->
        <div class="auto-setup-panel">
            <h2>⚡ 快速設定</h2>
            <p>一鍵自動設定分片系統，無需手動配置</p>
            <button class="btn btn-secondary" onclick="autoSetup()">🔧 自動設定分片</button>
            <button class="btn btn-secondary" onclick="getShardStatus()">📊 查看分片狀態</button>
            <div id="setupResult"></div>
        </div>

        <!-- 智能搜尋 -->
        <div class="card">
            <h2>🔍 智能搜尋</h2>
            <div class="search-mode">
                <button class="btn active" id="fastMode" onclick="setSearchMode('fast')">⚡ 快速搜尋</button>
                <button class="btn" id="parallelMode" onclick="setSearchMode('parallel')">🔄 並行搜尋</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchQuery" class="search-input" placeholder="輸入姓名、公司或職位..." onkeyup="handleSearchInput(event)">
                <button class="btn" onclick="performSearch()">搜尋</button>
                <button class="btn btn-secondary" onclick="clearSearch()">清除</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- 用戶註冊 -->
        <div class="card">
            <h2>👤 用戶註冊</h2>
            <div class="input-group">
                <label>用戶ID (自動分配):</label>
                <input type="number" id="userId" placeholder="留空自動分配，或手動輸入1-1000000">
            </div>
            <div class="input-group">
                <label>姓名:</label>
                <input type="text" id="userName" placeholder="請輸入姓名">
            </div>
            <div class="input-group">
                <label>公司:</label>
                <input type="text" id="userCompany" placeholder="請輸入公司名稱">
            </div>
            <div class="input-group">
                <label>職位:</label>
                <input type="text" id="userTitle" placeholder="請輸入職位">
            </div>
            <div class="input-group">
                <label>聯絡方式:</label>
                <input type="text" id="userContact" placeholder="電話或Email">
            </div>
            <button class="btn" onclick="registerUser()">🎯 智能註冊</button>
            <button class="btn btn-secondary" onclick="batchRegister()">📦 批量註冊</button>
            <div id="registerResult"></div>
        </div>

        <!-- 系統狀態 -->
        <div class="card">
            <h2>📊 系統狀態</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">總用戶數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeShards">0</div>
                    <div class="stat-label">活躍分片</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="searchSpeed">0ms</div>
                    <div class="stat-label">搜尋速度</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="systemHealth">100%</div>
                    <div class="stat-label">系統健康度</div>
                </div>
            </div>
            <div id="shardDetails"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://your-render-app.onrender.com/api';
        let currentSearchMode = 'fast';
        let searchTimeout;

        // 設定搜尋模式
        function setSearchMode(mode) {
            currentSearchMode = mode;
            document.getElementById('fastMode').classList.toggle('active', mode === 'fast');
            document.getElementById('parallelMode').classList.toggle('active', mode === 'parallel');
        }

        // 智能搜尋輸入處理
        function handleSearchInput(event) {
            if (event.key === 'Enter') {
                performSearch();
                return;
            }
            
            // 防抖動搜尋
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = event.target.value.trim();
                if (query.length >= 2) {
                    performSearch(true); // 自動搜尋
                }
            }, 300);
        }

        // 執行搜尋
        async function performSearch(isAuto = false) {
            const query = document.getElementById('searchQuery').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            if (!isAuto) {
                resultsDiv.innerHTML = '<div class="loading">🔍 搜尋中...</div>';
            }

            const startTime = Date.now();
            
            try {
                const endpoint = currentSearchMode === 'fast' ? 'search-fast' : 'search-parallel';
                const response = await fetch(`${API_BASE}/${endpoint}?q=${encodeURIComponent(query)}`);
                const result = await response.json();
                
                const searchTime = Date.now() - startTime;
                document.getElementById('searchSpeed').textContent = `${searchTime}ms`;
                
                if (result.results && result.results.length > 0) {
                    let html = `
                        <div class="info">
                            ✅ 找到 ${result.results.length} 個結果 (${searchTime}ms, ${result.source || result.search_time})
                        </div>
                    `;
                    
                    result.results.forEach(user => {
                        html += `
                            <div class="result-item">
                                <strong>${user.name}</strong> ${user.user_id ? `(ID: ${user.user_id})` : ''}
                                <br>🏢 ${user.company || 'N/A'}
                                <br>💼 ${user.title || 'N/A'}
                                <br>📍 分片: ${user.shard_index}
                            </div>
                        `;
                    });
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div class="info">🔍 未找到相關結果</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ 搜尋錯誤: ${error.message}</div>`;
            }
        }

        // 清除搜尋
        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // 註冊用戶
        async function registerUser() {
            const userId = parseInt(document.getElementById('userId').value) || Math.floor(Math.random() * 1000000) + 1;
            const userData = {
                name: document.getElementById('userName').value,
                company: document.getElementById('userCompany').value,
                title: document.getElementById('userTitle').value,
                contact: document.getElementById('userContact').value,
                created_at: new Date().toISOString()
            };

            if (!userData.name) {
                showResult('registerResult', '請填寫姓名', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, user_data: userData })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('registerResult', `
                        ✅ 註冊成功！
                        <div class="shard-info">
                            用戶ID: ${userId}<br>
                            分片: ${result.shard_info.index}<br>
                            狀態: ${result.shard_info.status}
                        </div>
                    `, 'success');
                    
                    // 更新統計
                    updateStats();
                } else {
                    showResult('registerResult', `❌ 註冊失敗: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('registerResult', `❌ 網路錯誤: ${error.message}`, 'error');
            }
        }

        // 批量註冊
        async function batchRegister() {
            const count = parseInt(prompt('要批量註冊多少個測試用戶？', '10'));
            if (!count || count < 1) return;

            const resultsDiv = document.getElementById('registerResult');
            resultsDiv.innerHTML = '<div class="loading">📦 批量註冊中...</div>';

            let successCount = 0;
            for (let i = 0; i < count; i++) {
                const userId = Math.floor(Math.random() * 1000000) + 1;
                const userData = {
                    name: `測試用戶${i + 1}`,
                    company: `公司${Math.floor(Math.random() * 100)}`,
                    title: `職位${Math.floor(Math.random() * 10)}`,
                    contact: `test${i}@example.com`
                };

                try {
                    const response = await fetch(`${API_BASE}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, user_data: userData })
                    });

                    if (response.ok) successCount++;
                } catch (error) {
                    console.error('批量註冊錯誤:', error);
                }

                // 更新進度
                const progress = Math.round((i + 1) / count * 100);
                resultsDiv.innerHTML = `
                    <div class="loading">📦 批量註冊中... ${i + 1}/${count}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                `;
            }

            showResult('registerResult', `✅ 批量註冊完成！成功: ${successCount}/${count}`, 'success');
            updateStats();
        }

        // 自動設定
        async function autoSetup() {
            const resultsDiv = document.getElementById('setupResult');
            resultsDiv.innerHTML = '<div class="loading">🔧 自動設定中...</div>';

            try {
                const response = await fetch(`${API_BASE}/auto-setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('setupResult', `
                        ✅ ${result.message}
                        <br>活躍分片: ${result.active_shards}
                    `, 'success');
                    updateStats();
                } else {
                    showResult('setupResult', `❌ 設定失敗: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('setupResult', `❌ 設定錯誤: ${error.message}`, 'error');
            }
        }

        // 獲取分片狀態
        async function getShardStatus() {
            try {
                const response = await fetch(`${API_BASE}/shard-status`);
                const result = await response.json();
                
                document.getElementById('activeShards').textContent = result.active_shards;
                
                let html = '<h3>📊 分片詳情</h3>';
                const activeShards = result.shards.filter(s => s.status === 'active');
                activeShards.slice(0, 5).forEach(shard => {
                    const usage = Math.round((shard.user_count / shard.max_users) * 100);
                    html += `
                        <div class="shard-info">
                            分片 ${shard.index}: ${shard.user_count}/${shard.max_users} 用戶 (${usage}%)
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${usage}%"></div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('shardDetails').innerHTML = html;
            } catch (error) {
                console.error('獲取分片狀態錯誤:', error);
            }
        }

        // 更新統計
        function updateStats() {
            // 這裡可以實現實時統計更新
            getShardStatus();
        }

        // 顯示結果
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            
            // 每30秒更新一次統計
            setInterval(updateStats, 30000);
        });
    </script>
</body>
</html>
